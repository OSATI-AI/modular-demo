task_id: "task_multiple_choice"
template_id: "template_multiple_choice"
title: "Multiple Choice Question"
description: "Select the correct answer."
topic_id: 1
events:
  send: ["evaluationResult", "task_details", "task_loaded"]
  receive: ["evaluate", "refresh", "get_task_details"]
script: |
  let exercise;
  const { questionElement, choiceElements } = playerApi.callTemplateScript('createLayout', {
    choices: 4,
    choicesData: []
  });

  function generateExercise() {
    const choices = [
      { text: "Berlin", value: "Berlin" },
      { text: "Madrid", value: "Madrid" },
      { text: "Paris", value: "Paris" },
      { text: "Rome", value: "Rome" }
    ];
    const correctAnswerId = 2; // Index of the correct answer
    return { choices, correctAnswerId };
  }

  function populateChoices() {
    exercise.choices.forEach((choice, index) => {
      choiceElements[index].innerText = choice.text;
      choiceElements[index].dataset.choice = choice.value;
    });
  }

  function init() {
    playerApi.receiveEvent('evaluate', function() {
      const selectedChoiceElement = document.querySelector('.choice.selected');
      if (!selectedChoiceElement) {
        playerApi.sendEvent('evaluationResult', { result: 'No choice selected' });
        return;
      }
      const selectedId = Array.from(choiceElements).indexOf(selectedChoiceElement);
      const isCorrect = selectedId === exercise.correctAnswerId;
      playerApi.sendEvent('evaluationResult', {
        selectedId,
        selectedContent: selectedChoiceElement.innerText,
        isCorrect
      });
    });

    playerApi.receiveEvent('refresh', function() {
      selectedChoice = null;
      choiceElements.forEach(choice => choice.classList.remove('selected'));
      exercise = generateExercise();
      populateChoices();
    });

    playerApi.receiveEvent('get_task_details', function() {
      const taskDetails = playerApi.getTaskDetails();
      const dynamicDetails = `Current exercise: What is the capital of France? Choices: ${exercise.choices.map(c => c.text).join(', ')}.`;
      playerApi.sendEvent('task_details', {
        staticInfo: taskDetails.description,
        dynamicDetails: dynamicDetails
      });
    });
  }

  init();
  exercise = generateExercise();
  questionElement.innerText = "What is the capital of France?";
  populateChoices();
  playerApi.sendEvent('task_loaded', {});
