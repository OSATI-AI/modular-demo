task_id: "task_multiple_choice"
template_id: "template_multiple_choice"
title: "Multiple Choice Question"
description: "Select the correct answer."
topic_id: 1
events:
  send: ["evaluationResult"]
  receive: ["evaluate", "refresh"]
script: |
  function generateExercise() {
    const choices = [
      { text: "Berlin", value: "Berlin" },
      { text: "Madrid", value: "Madrid" },
      { text: "Paris", value: "Paris" },
      { text: "Rome", value: "Rome" }
    ];
    const correctAnswerId = 2; // Index of the correct answer
    return { choices, correctAnswerId };
  }

  const { questionElement, choiceElements } = playerApi.callTemplateScript('createLayout', {
    choices: 4,
    choicesData: generateExercise().choices
  });

  let exercise = generateExercise();
  questionElement.innerText = "What is the capital of France?";
  
  function populateChoices() {
    exercise.choices.forEach((choice, index) => {
      choiceElements[index].innerText = choice.text;
      choiceElements[index].dataset.choice = choice.value;
    });
  }

  populateChoices();

  playerApi.receiveEvent('evaluate', function() {
    const selectedChoiceElement = document.querySelector('.choice.selected');
    if (!selectedChoiceElement) {
      playerApi.sendEvent('evaluationResult', { result: 'No choice selected' });
      return;
    }
    const selectedId = Array.from(choiceElements).indexOf(selectedChoiceElement);
    const isCorrect = selectedId === exercise.correctAnswerId;
    playerApi.sendEvent('evaluationResult', {
      selectedId,
      selectedContent: selectedChoiceElement.innerText,
      isCorrect
    });
  });

  playerApi.receiveEvent('refresh', function() {
    selectedChoice = null;
    choiceElements.forEach(choice => choice.classList.remove('selected'));
    exercise = generateExercise();
    populateChoices();
  });
